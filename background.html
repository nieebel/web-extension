<html>
    <head><title></title>
<script>
  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    url = tab.url;
    var prot = url.substring(0,6);
    if(prot == 'chrome'){
        // Don't show anything for chrome pages
        return;
    }
    doRequest(url,tabId);
  });

  function doRequest(url,tabId)
  {
    //document.getElementById("req").innerText = url;
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "http://api.cleanbits.net/json-multi.php?url="+url, true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            //document.getElementById("resp").innerText = xhr.responseText;
            var resp = JSON.parse(xhr.responseText);
            if(resp.green){
                chrome.pageAction.setIcon({'tabId' : tabId, 'path' : 'images/green20x20.gif'});
                chrome.pageAction.show(tabId);
            }else{
                chrome.pageAction.setIcon({'tabId' : tabId, 'path' : 'images/grey20x20.gif'});
                chrome.pageAction.show(tabId);
            }
        }
    }
    xhr.send();
  }
</script>
</head>
<body>
    <div id="resp"></div>
    <div id="req"></div>
</body>
</html>